{% extends 'administrador_base.html' %}

{% load static %}

{% block title %}Gestión de terapeutas{% endblock %}

{% block extra_head%}

<link rel="stylesheet" href="{% static 'styles/agregar_terapeuta.css' %}">
<link rel="stylesheet" href="{% static 'styles/formularios.css' %}">
<link rel="stylesheet" href="{% static 'styles/modal.css' %}">
{% endblock %}

{% block header %}
<div class="contenedor-header">
    <a href="{% url 'listar_terapeutas_activos' %}">
        <img src="{% static 'icons/Volver-atras.svg' %}" alt="">
    </a>
    <h1>Agregar terapeuta</h1>
</div>
{% endblock %}

{% block content %}

<!-- Formulario para agregar un terapeuta -->
<form action="{% url 'agregar_terapeuta' %}" method="POST" onsubmit="return mostrarMensajeExito()">
    {% csrf_token %}
    <h2> Datos del terapeuta </h2>

    {% comment %} DATOS DEL TERAPEUTA COLUMNA IZQUIERDA {% endcomment %}
    <div class="divisor-formulario">
        <div class="datos-columna-izquierda">

            <!-- Campo RUT -->
            <div class="form-group">
                <label for="{{ terapeuta_form.rut.id_for_label }}">{{ terapeuta_form.rut.label }}</label>
                {{ terapeuta_form.rut }}
                <div class="error">{{ terapeuta_form.rut.errors }}</div>
            </div>
    
            <!-- Campo Nombre -->
            <div class="form-group">
                <label for="{{ terapeuta_form.first_name.id_for_label }}">{{ terapeuta_form.first_name.label }}</label>
                {{ terapeuta_form.first_name }}
                <div class="error">{{ terapeuta_form.first_name.errors }}</div>
            </div>
    
            <!-- Campo Apellido -->
            <div class="form-group">
                <label for="{{ terapeuta_form.last_name.id_for_label }}">{{ terapeuta_form.last_name.label }}</label>
                {{ terapeuta_form.last_name }}
                <div class="error">{{ terapeuta_form.last_name.errors }}</div>
            </div>
    
            <!-- Campo Email -->
            <div class="form-group">
                <label for="{{ terapeuta_form.email.id_for_label }}">{{ terapeuta_form.email.label }}</label>
                {{ terapeuta_form.email }}
                <div class="error">{{ terapeuta_form.email.errors }}</div>
            </div>
    
            <!-- Campo Teléfono -->
            <div class="form-group">
                <label for="{{ terapeuta_form.telefono.id_for_label }}">{{ terapeuta_form.telefono.label }}</label>
                {{ terapeuta_form.telefono }}
                <div class="error">{{ terapeuta_form.telefono.errors }}</div>
            </div>
    
            <!-- Campo Fecha de Nacimiento -->
            <div class="form-group">
                <label for="{{ terapeuta_form.fecha_nacimiento.id_for_label }}">{{ terapeuta_form.fecha_nacimiento.label }}</label>
                {{ terapeuta_form.fecha_nacimiento }}
                <div class="error">{{ terapeuta_form.fecha_nacimiento.errors }}</div>
            </div>
    
            <!-- Campo Dirección -->
            <div class="form-group">
                <label for="{{ terapeuta_form.direccion.id_for_label }}">{{ terapeuta_form.direccion.label }}</label>
                {{ terapeuta_form.direccion }}
                <div class="error">{{ terapeuta_form.direccion.errors }}</div>
            </div>
    
            <!-- Campo Región -->
            <div class="form-group">
                <label for="{{ terapeuta_form.region.id_for_label }}">{{ terapeuta_form.region.label }}</label>
                {{ terapeuta_form.region }}
                <div class="error">{{ terapeuta_form.region.errors }}</div>
            </div>

            <!-- Campo Comuna -->
            <div class="form-group">
                <label for="{{ terapeuta_form.comuna.id_for_label }}">{{ terapeuta_form.comuna.label }}</label>
                {{ terapeuta_form.comuna }}
                <div class="error">{{ terapeuta_form.comuna.errors }}</div>
            </div>
    
        </div>
    
        {% comment %} DATOS DEL TERAPEUTA COLUMNA DERECHA {% endcomment %}
    
        <div class="datos-columna-derecha">
    
            <!-- Campo Sexo -->
            <div class="form-group">
                <label for="{{ terapeuta_form.sexo.id_for_label }}">{{ terapeuta_form.sexo.label }}</label>
                {{ terapeuta_form.sexo }}
                <div class="error">{{ terapeuta_form.sexo.errors }}</div>
            </div>
    
            <!-- Campo Especialidad -->
            <div class="form-group">
                <label for="{{ terapeuta_form.especialidad.id_for_label }}">{{ terapeuta_form.especialidad.label }}</label>
                {{ terapeuta_form.especialidad }}
                <div class="error">{{ terapeuta_form.especialidad.errors }}</div>
            </div>
    
            <!-- Campo Fecha de Contratación -->
            <div class="form-group">
                <label for="{{ terapeuta_form.fecha_contratacion.id_for_label }}">{{ terapeuta_form.fecha_contratacion.label }}</label>
                {{ terapeuta_form.fecha_contratacion }}
                <div class="error">{{ terapeuta_form.fecha_contratacion.errors }}</div>
            </div>
    
            <!-- Campo Título -->
            <div class="form-group">
                <label for="{{ terapeuta_form.titulo.id_for_label }}">{{ terapeuta_form.titulo.label }}</label>
                {{ terapeuta_form.titulo }}
                <div class="error">{{ terapeuta_form.titulo.errors }}</div>
            </div>
    
            <!-- Campo Experiencia -->
            <div class="form-group">
                <label for="{{ terapeuta_form.experiencia.id_for_label }}">{{ terapeuta_form.experiencia.label }}</label>
                {{ terapeuta_form.experiencia }}
                <div class="error">{{ terapeuta_form.experiencia.errors }}</div>
            </div>
    
            <!-- Campo Presentación -->
            <div class="form-group">
                <label for="{{ terapeuta_form.presentacion.id_for_label }}">{{ terapeuta_form.presentacion.label }}</label>
                {{ terapeuta_form.presentacion }}
                <div class="error">{{ terapeuta_form.presentacion.errors }}</div>
            </div>
    
            <!-- Campo Correo de Contacto -->
            <div class="form-group">
                <label for="{{ terapeuta_form.correo_contacto.id_for_label }}">{{ terapeuta_form.correo_contacto.label }}</label>
                {{ terapeuta_form.correo_contacto }}
                <div class="error">{{ terapeuta_form.correo_contacto.errors }}</div>
            </div>
    
        </div>
    </div>

    <h2>Horarios del terapeuta</h2>
    <div class="datos-inferiores">
        <table class="table">
            <thead>
                <tr>
                    <th>Día</th>
                    <th>Hora de Inicio</th>
                    <th>Hora de Fin</th>
                    <th class="columna-eliminar">Eliminar</th>
                </tr>
            </thead>

            <label for="fulltime-checkbox">Horario Fulltime</label>
            <input class="fulltime-checkbox" type="checkbox" id="fulltime-checkbox" name="fulltime-checkbox">
            <label for="weekend-parttime-checkbox">Horario Part Time (Fin de Semana)</label>
            <input class="weekend-parttime-checkbox" type="checkbox" id="weekend-parttime-checkbox" name="weekend-parttime-checkbox">

            <tbody id="horarios-tbody">
                <!-- Aquí se agregarán dinámicamente las filas -->
            </tbody>
        </table>
        <button type="button" class="boton-azul" id="agregar-horario">Añadir Horario +</button>
    </div>    

    <div class="contenedor-botones">
        <button class="boton-cancelar" id="boton-cancelar">Cancelar</button>
        <button class="boton-azul" type="submit">Agregar terapeuta</button>
    </div>

    
</form>

<!-- Script para añadir un nuevo formulario de horario -->
<script>

    document.addEventListener('DOMContentLoaded', () => {
        const tbody = document.getElementById('horarios-tbody');
        const addButton = document.getElementById('agregar-horario');
        const fulltimeCheckbox = document.getElementById('fulltime-checkbox');
        const weekendParttimeCheckbox = document.getElementById('weekend-parttime-checkbox');
    
        // Plantilla de fila
        const createRow = (dia = '', horaInicio = '', horaFinal = '') => `
            <tr class="horario-fila">
                <td>
                    <select class="seleccion" name="dia">
                        <option value="" ${dia === '' ? 'selected' : ''}>Seleccione un día</option>
                        <option value="Lunes" ${dia === 'Lunes' ? 'selected' : ''}>Lunes</option>
                        <option value="Martes" ${dia === 'Martes' ? 'selected' : ''}>Martes</option>
                        <option value="Miércoles" ${dia === 'Miércoles' ? 'selected' : ''}>Miércoles</option>
                        <option value="Jueves" ${dia === 'Jueves' ? 'selected' : ''}>Jueves</option>
                        <option value="Viernes" ${dia === 'Viernes' ? 'selected' : ''}>Viernes</option>
                        <option value="Sábado" ${dia === 'Sábado' ? 'selected' : ''}>Sábado</option>
                        <option value="Domingo" ${dia === 'Domingo' ? 'selected' : ''}>Domingo</option>
                    </select>
                </td>
                <td>
                    <input class="campo-formulario" type="time" name="hora_inicio" value="${horaInicio}">
                </td>
                <td>
                    <input class="campo-formulario" type="time" name="hora_final" value="${horaFinal}">
                </td>
                <td class="columna-eliminar">
                    <button type="button" class="boton-eliminar">Eliminar</button>
                </td>
            </tr>
        `;
    
        // Función para actualizar el estado del botón "Eliminar"
        const updateDeleteButtonState = () => {
            const deleteButtons = tbody.querySelectorAll('.boton-eliminar');
            deleteButtons.forEach(button => {
                if (deleteButtons.length === 1) {
                    button.disabled = true;
                    button.classList.add('boton-desactivado');
                } else {
                    button.disabled = false;
                    button.classList.remove('boton-desactivado');
                }
            });
        };
    
        // Agregar fila al hacer clic en el botón
        addButton.addEventListener('click', () => {
            tbody.insertAdjacentHTML('beforeend', createRow());
            updateDeleteButtonState();
        });
    
        // Eliminar fila al hacer clic en el botón de eliminar
        tbody.addEventListener('click', (e) => {
            if (e.target.classList.contains('boton-eliminar') && !e.target.disabled) {
                const row = e.target.closest('tr');
                if (row) {
                    row.remove();
                    updateDeleteButtonState();
                }
            }
        });
    
        // Rellenar horarios para Full Time
        fulltimeCheckbox.addEventListener('change', () => {
            if (fulltimeCheckbox.checked) {
                weekendParttimeCheckbox.checked = false;
    
                // Limpiar horarios actuales y agregar Full Time
                tbody.innerHTML = '';
                const diasFullTime = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];
                diasFullTime.forEach(dia => {
                    tbody.insertAdjacentHTML('beforeend', createRow(dia, '08:00', '18:00'));
                });
            } else {
                tbody.innerHTML = ''; // Restablecer horarios
                tbody.insertAdjacentHTML('beforeend', createRow()); // Agregar una fila vacía
            }
            updateDeleteButtonState();
        });
    
        // Rellenar horarios para Part Time
        weekendParttimeCheckbox.addEventListener('change', () => {
            if (weekendParttimeCheckbox.checked) {
                fulltimeCheckbox.checked = false;
    
                // Limpiar horarios actuales y agregar Part Time
                tbody.innerHTML = '';
                const diasPartTime = ['Sábado', 'Domingo'];
                diasPartTime.forEach(dia => {
                    tbody.insertAdjacentHTML('beforeend', createRow(dia, '08:00', '18:00'));
                });
            } else {
                tbody.innerHTML = ''; // Restablecer horarios
                tbody.insertAdjacentHTML('beforeend', createRow()); // Agregar una fila vacía
            }
            updateDeleteButtonState();
        });
    
        // Crear fila inicial al cargar la página
        tbody.insertAdjacentHTML('beforeend', createRow());
        updateDeleteButtonState();
    });
    

</script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var regionField = document.getElementById("id_region");
        var comunaField = document.getElementById("id_comuna");

        regionField.addEventListener("change", function() {
            var regionId = this.value;
            comunaField.innerHTML = ""; // Limpiar opciones anteriores

            if (regionId) {
                fetch(`/api/comunas/?region=${regionId}`)
                .then(response => response.json())
                .then(data => {
                    // Actualizar opciones del campo de selección de comuna
                    data.forEach(comuna => {
                        var option = document.createElement("option");
                        option.value = comuna.id;
                        option.textContent = comuna.nombre;
                        comunaField.appendChild(option);
                    });
                });
            }
        });
    });
</script>

<script>
    document.getElementById("boton-cancelar").addEventListener("click", function(){
        window.location.href = "{% url 'listar_terapeutas_activos' %}";
    });
</script>
{% endblock %}
{% block extra_js %}
<script src="{% static 'js/formatear-rut.js' %}"></script>
<script src="{% static 'js/formatear-telefono.js' %}"></script>
{% endblock %}
