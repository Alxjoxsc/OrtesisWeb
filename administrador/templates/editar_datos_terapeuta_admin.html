{% extends 'administrador_base.html' %}

{% load static %}

{% block title %}Editar Terapeuta{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/editar_datos_terapeuta_admin.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

{% endblock %}

{% block header %}
<a href="{% url 'mostrar_terapeuta_administrador' terapeuta.id %}">
    <img src="{% static 'icons/Volver-atras.svg' %}" alt="">
</a>
<h1>Editar terapeuta</h1>
{% endblock %}

{% block content %}

<form method="POST" action="{% url 'editar_datos_terapeuta_admin' terapeuta.id %}" id="editar-form">
    {% csrf_token %}
    <h2> Datos del terapeuta</h2>
    <h4> Los campos con (*) son obligatorios </h4>
    
    {% comment %} DATOS DEL terapeuta COLUMNA IZQUIERDA {% endcomment %}
    <div class="divisor-formulario">
        <div class="datos-columna-izquierda">
            <!-- Campo RUT -->
            <div class="form-group">
                <label for="{{ terapeuta_form.rut.id_for_label }}">{{ terapeuta_form.rut.label }}</label>
                {{ terapeuta_form.rut }}
                <div class="error">{{ terapeuta_form.rut.errors }}</div>
            </div>
            
            <!-- Campo Nombre -->
            <div class="form-group">
                <label for="{{ terapeuta_form.first_name.id_for_label }}">{{ terapeuta_form.first_name.label }}</label>
                {{ terapeuta_form.first_name }}
                <div class="error">{{ terapeuta_form.first_name.errors }}</div>
            </div>
            
            <!-- Campo Apellido -->
            <div class="form-group">
                <label for="{{ terapeuta_form.last_name.id_for_label }}">{{ terapeuta_form.last_name.label }}</label>
                {{ terapeuta_form.last_name }}
                <div class="error">{{ terapeuta_form.last_name.errors }}</div>
            </div>


            <!-- Teléfono -->
            <div class="form-group">
                <label for="{{ terapeuta_form.telefono.id_for_label }}">{{ terapeuta_form.telefono.label }}</label>
                {{ terapeuta_form.telefono }}
                <div class="error">{{ terapeuta_form.telefono.errors }}</div>
            </div>

            <!-- Fecha de Nacimiento -->
            <div class="form-group">
                <label for="{{ terapeuta_form.fecha_nacimiento.id_for_label }}">{{ terapeuta_form.fecha_nacimiento.label }}</label>
                {{ terapeuta_form.fecha_nacimiento }}
                <div class="error">{{ terapeuta_form.fecha_nacimiento.errors }}</div>
            </div>

            <!-- Dirección -->
            <div class="form-group">
                <label for="{{ terapeuta_form.direccion.id_for_label }}">{{ terapeuta_form.direccion.label }}</label>
                {{ terapeuta_form.direccion }}
                <div class="error">{{ terapeuta_form.direccion.errors }}</div>
            </div>

            <!-- Región -->
            <div class="form-group">
                <label for="{{ terapeuta_form.region.id_for_label }}">{{ terapeuta_form.region.label }}</label>
                {{ terapeuta_form.region }}
                <div class="error">{{ terapeuta_form.region.errors }}</div>
            </div>

            <!-- Comuna -->
            <div class="form-group">
                <label for="{{ terapeuta_form.comuna.id_for_label }}">{{ terapeuta_form.comuna.label }}</label>
                {{ terapeuta_form.comuna }}
                <div class="error">{{ terapeuta_form.comuna.errors }}</div>
            </div>

            <!-- Presentación -->
            <div class="form-group">
                <label for="{{ terapeuta_form.presentacion.id_for_label }}">{{ terapeuta_form.presentacion.label }}</label>
                {{ terapeuta_form.presentacion }}
                <div class="error">{{ terapeuta_form.presentacion.errors }}</div>
            </div>
        </div>

        {% comment %} DATOS DEL terapeuta COLUMNA DERECHA {% endcomment %}
        
        <div class="datos-columna-derecha">

            <!-- Sexo -->
            <div class="form-group">
                <label for="{{ terapeuta_form.sexo.id_for_label }}">{{ terapeuta_form.sexo.label }}</label>
                {{ terapeuta_form.sexo }}
                <div class="error">{{ terapeuta_form.sexo.errors }}</div>
            </div>

            <!-- Campo Especialidad -->
            <div class="form-group">
                <label for="{{ terapeuta_form.especialidad.id_for_label }}">{{ terapeuta_form.especialidad.label }}</label>
                {{ terapeuta_form.especialidad }}
                <div class="error">{{ terapeuta_form.especialidad.errors }}</div>
            </div>

            <!-- Fecha de Contratación -->
            <div class="form-group">
                <label for="fecha_contratacion">Fecha de Contratación:</label>
                <div class="fecha_contratacion">
                    <input type="date" id="fecha_contratacion" name="fecha_contratacion" value="{{ terapeuta.fecha_contratacion|date:'Y-m-d' }}" readonly>
                </div>
            </div>

            <!-- Título -->
            <div class="form-group">
                <label for="{{ terapeuta_form.titulo.id_for_label }}">{{ terapeuta_form.titulo.label }}</label>
                {{ terapeuta_form.titulo }}
                <div class="error">{{ terapeuta_form.titulo.errors }}</div>
            </div>

            <!-- Años de Experiencia -->
            <div class="form-group">
                <label for="{{ terapeuta_form.experiencia.id_for_label }}">{{ terapeuta_form.experiencia.label }}</label>
                {{ terapeuta_form.experiencia }}
                <div class="error">{{ terapeuta_form.experiencia.errors }}</div>
            </div>

            <!-- Correo Electrónico de Contacto -->
            <div class="form-group">
                <label for="{{ terapeuta_form.correo_contacto.id_for_label }}">{{ terapeuta_form.correo_contacto.label }}</label>
                {{ terapeuta_form.correo_contacto }}
                <div class="error">{{ terapeuta_form.correo_contacto.errors }}</div>
            </div>

            <!-- Fecha de Ingreso -->
            <div class="form-group">
                <label for="{{ terapeuta_form.fecha_ingreso.id_for_label }}">{{ terapeuta_form.fecha_ingreso.label }}</label>
                {{ terapeuta_form.fecha_ingreso }}
                <div class="error">{{ terapeuta_form.fecha_ingreso.errors }}</div>
            </div>

            <!-- Campo Disponibilidad -->
            <div class="form-group">
                <label for="{{ terapeuta_form.disponibilidad.id_for_label }}">{{ terapeuta_form.disponibilidad.label }}</label>
                {{ terapeuta_form.disponibilidad }}
                <div class="error">{{ terapeuta_form.disponibilidad.errors }}</div>
            </div>
        </div>
    </div>


    <h2>Horarios del terapeuta</h2>
    <div class="datos-inferiores">
        <table class="table">
            <thead>
                <tr>
                    <th>Día</th>
                    <th>Hora de Inicio</th>
                    <th>Hora de Fin</th>
                    <th class="columna-eliminar">Eliminar</th>
                </tr>
            </thead>

            <label for="fulltime-checkbox">Horario Fulltime</label>
            <input class="fulltime-checkbox" type="checkbox" id="fulltime-checkbox" name="fulltime-checkbox">
            <label for="weekend-parttime-checkbox">Horario Part Time (Fin de Semana)</label>
            <input class="weekend-parttime-checkbox" type="checkbox" id="weekend-parttime-checkbox" name="weekend-parttime-checkbox">
            <!-- Campo oculto para almacenar el número de filas (horarios) -->
            <input type="hidden" id="num_horarios" name="num_horarios">


            <tbody id="horarios-tbody">
                <!-- Aquí se agregarán dinámicamente las filas -->
            </tbody>
        </table>
        <button type="button" class="boton-azul" id="agregar-horario">Añadir Horario +</button>
    </div>    

    <div class="contenedor-botones">
        <button class="boton-cancelar" id="boton-cancelar">Cancelar</button>
        <button class="boton-azul" type="submit">Confirmar cambios</button>
    </div>
  
    <!-- Modal de éxito -->
    <div id="modalExito" class="modal" style="display: none;">
        <div class="contenido-modal">
            <img src="{% static 'icons/Exito.svg' %}" alt="Éxito">
            <p>¡Datos actualizados con éxito!</p>
        </div>
    </div>
</form>

<script>
    // Cuando se envía el formulario
    document.getElementById("editar-form").addEventListener("submit", function(event) {
        event.preventDefault(); // Prevenir el comportamiento por defecto del formulario

        var form = new FormData(this); // Obtener los datos del formulario

        fetch("{% url 'editar_datos_terapeuta_admin' terapeuta.id %}", {
            method: 'POST',
            body: form,
        })
        .then(response => response.json()) // Obtener la respuesta como JSON
        .then(data => {
            if (data.success) {
                // Mostrar el modal de éxito si la respuesta es exitosa
                document.getElementById("modalExito").style.display = "block";
                setTimeout(function() {
                    document.getElementById("modalExito").style.display = "none";
                }, 3000); // Ocultar el modal después de 3 segundos
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });

    document.getElementById("boton-cancelar").addEventListener("click", function(){
        window.location.href = "{% url 'mostrar_terapeuta_administrador' terapeuta.id %}";
    });

    document.addEventListener("DOMContentLoaded", function() {
        var regionField = document.getElementById("id_region");
        var comunaField = document.getElementById("id_comuna");

        regionField.addEventListener("change", function() {
            var regionId = this.value;
            comunaField.innerHTML = ""; // Limpiar opciones anteriores

            if (regionId) {
                fetch(`/api/comunas/?region=${regionId}`)
                .then(response => response.json())
                .then(data => {
                    // Actualizar opciones del campo de selección de comuna
                    data.forEach(comuna => {
                        var option = document.createElement("option");
                        option.value = comuna.id;
                        option.textContent = comuna.nombre;
                        comunaField.appendChild(option);
                    });
                });
            }
        });
    });
</script>

<script>
    // Asegúrate de que los horarios sean inyectados correctamente en JavaScript
    window.horariosOriginales = {{ horarios|safe }};
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const tbody = document.getElementById('horarios-tbody');
        const addHorarioButton = document.getElementById('agregar-horario');
        const fullTimeCheckbox = document.getElementById('fulltime-checkbox');
        const partTimeCheckbox = document.getElementById('weekend-parttime-checkbox');
        const numHorariosInput = document.getElementById('num_horarios');  // Campo oculto
    
        let originalSchedules = {{ horarios|safe }}; // Horarios originales cargados desde el backend
    
        // Función para crear una nueva fila vacía
        const createEmptyRow = () => {
            const tr = document.createElement('tr');
            const rowCount = tbody.rows.length;  // Obtener el número de filas actuales
            tr.innerHTML = `
                <td>
                    <select class="seleccion" name="horarios[${rowCount}][dia]">
                        <option value="" selected disabled>Día</option>
                        <option value="Lunes">Lunes</option>
                        <option value="Martes">Martes</option>
                        <option value="Miércoles">Miércoles</option>
                        <option value="Jueves">Jueves</option>
                        <option value="Viernes">Viernes</option>
                        <option value="Sábado">Sábado</option>
                        <option value="Domingo">Domingo</option>
                    </select>
                </td>
                <td>
                    <input type="time" class="hora-inicio campo-formulario" name="horarios[${rowCount}][hora_inicio]">
                </td>
                <td>
                    <input type="time" class="hora-final campo-formulario" name="horarios[${rowCount}][hora_final]">
                </td>
                <td>
                    <button type="button" class="eliminar-horario">Eliminar</button>
                </td>
            `;
            tbody.appendChild(tr);
            updateDeleteButtons();
            updateNumHorarios();  // Actualizar el número de horarios
        };
    
        // Función para actualizar el número de horarios
        const updateNumHorarios = () => {
            numHorariosInput.value = tbody.rows.length;  // Establecer el valor del campo oculto
        };
    
        // Función para cargar horarios originales
        const loadOriginalSchedules = (schedules) => {
            originalSchedules = schedules; // Guardar horarios originales
            tbody.innerHTML = ''; // Limpiar el tbody
            schedules.forEach((schedule, index) => { // 'index' se usará como el número dinámico
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><select class="seleccion" name="horarios[${index}][dia]">
                            <option value="Lunes" ${schedule.dia === 'Lunes' ? 'selected' : ''}>Lunes</option>
                            <option value="Martes" ${schedule.dia === 'Martes' ? 'selected' : ''}>Martes</option>
                            <option value="Miércoles" ${schedule.dia === 'Miércoles' ? 'selected' : ''}>Miércoles</option>
                            <option value="Jueves" ${schedule.dia === 'Jueves' ? 'selected' : ''}>Jueves</option>
                            <option value="Viernes" ${schedule.dia === 'Viernes' ? 'selected' : ''}>Viernes</option>
                            <option value="Sábado" ${schedule.dia === 'Sábado' ? 'selected' : ''}>Sábado</option>
                            <option value="Domingo" ${schedule.dia === 'Domingo' ? 'selected' : ''}>Domingo</option>
                        </select>
                    </td>
                    <td>
                        <input type="time" class="hora-inicio campo-formulario" name="horarios[${index}][hora_inicio]" value="${schedule.hora_inicio}">
                    </td>
                    <td>
                        <input type="time" class="hora-final campo-formulario" name="horarios[${index}][hora_final]" value="${schedule.hora_final}">
                    </td>
                    <td><button type="button" class="eliminar-horario">Eliminar</button></td>
                `;
                tbody.appendChild(tr);
            });
            updateDeleteButtons();
            updateNumHorarios();  // Actualizar el número de horarios
        };
    
        // Función para habilitar/deshabilitar botones de eliminar
        const updateDeleteButtons = () => {
            const deleteButtons = document.querySelectorAll('.eliminar-horario');
            deleteButtons.forEach(button => {
                button.disabled = (tbody.children.length === 1);
                button.classList.toggle('disabled', tbody.children.length === 1);
            });
        };
    
        // Función para rellenar horarios según checkbox
        const fillSchedules = (isFullTime) => {
            const schedules = isFullTime
                ? [
                    { dia: 'Lunes', hora_inicio: '08:00', hora_final: '18:00' },
                    { dia: 'Martes', hora_inicio: '08:00', hora_final: '18:00' },
                    { dia: 'Miércoles', hora_inicio: '08:00', hora_final: '18:00' },
                    { dia: 'Jueves', hora_inicio: '08:00', hora_final: '18:00' },
                    { dia: 'Viernes', hora_inicio: '08:00', hora_final: '18:00' }
                ]
                : [
                    { dia: 'Sábado', hora_inicio: '08:00', hora_final: '18:00' },
                    { dia: 'Domingo', hora_inicio: '08:00', hora_final: '18:00' }
                ];
            loadOriginalSchedules(schedules);
        };
    
        // Eventos de checkboxes
        fullTimeCheckbox.addEventListener('change', () => {
            if (fullTimeCheckbox.checked) {
                partTimeCheckbox.checked = false;
                fillSchedules(true);
            } else {
                loadOriginalSchedules(window.horariosOriginales); // Volver a los horarios originales
            }
        });
    
        partTimeCheckbox.addEventListener('change', () => {
            if (partTimeCheckbox.checked) {
                fullTimeCheckbox.checked = false;
                fillSchedules(false);
            } else {
                loadOriginalSchedules(window.horariosOriginales); // Volver a los horarios originales
            }
        });
    
        // Evento para añadir nuevas filas
        addHorarioButton.addEventListener('click', createEmptyRow);
    
        // Evento para eliminar filas
        tbody.addEventListener('click', (e) => {
            if (e.target.classList.contains('eliminar-horario')) {
                e.target.closest('tr').remove();
                updateDeleteButtons();
                updateNumHorarios();  // Actualizar el número de horarios después de eliminar una fila
            }
        });
    
        // Cargar horarios originales al inicio
        loadOriginalSchedules(window.horariosOriginales || []);
    });
    

</script>

<script src="{% static 'js/formatear-rut.js' %}"></script>
<script src="{% static 'js/formatear-telefono.js' %}"></script>
{% endblock %}