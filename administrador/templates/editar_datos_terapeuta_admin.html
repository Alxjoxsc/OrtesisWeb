{% extends 'administrador_base.html' %}

{% load static %}

{% block title %}Editar Terapeuta{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/editar_datos_terapeuta_admin.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

{% endblock %}

{% block header %}
<a href="{% url 'mostrar_terapeuta_administrador' terapeuta.id %}">
    <img src="{% static 'icons/Volver-atras.svg' %}" alt="">
</a>
<h1>Editar terapeuta</h1>
{% endblock %}

{% block content %}

<form method="POST" action="{% url 'editar_datos_terapeuta_admin' terapeuta.id %}" onsubmit="return mostrarMensajeExito()">
    {% csrf_token %}
    <h2> Datos del terapeuta</h2>
    <h4> Los campos con (*) son obligatorios </h4>
    
    {% comment %} DATOS DEL terapeuta COLUMNA IZQUIERDA {% endcomment %}
    <div class="divisor-formulario">
        <div class="datos-columna-izquierda">
            <!-- Campo RUT -->
            <div class="form-group">
                <label for="{{ terapeuta_form.rut.id_for_label }}">{{ terapeuta_form.rut.label }}</label>
                {{ terapeuta_form.rut }}
                <div class="error">{{ terapeuta_form.rut.errors }}</div>
            </div>
            
            <!-- Campo Nombre -->
            <div class="form-group">
                <label for="{{ terapeuta_form.first_name.id_for_label }}">{{ terapeuta_form.first_name.label }}</label>
                {{ terapeuta_form.first_name }}
                <div class="error">{{ terapeuta_form.first_name.errors }}</div>
            </div>
            
            <!-- Campo Apellido -->
            <div class="form-group">
                <label for="{{ terapeuta_form.last_name.id_for_label }}">{{ terapeuta_form.last_name.label }}</label>
                {{ terapeuta_form.last_name }}
                <div class="error">{{ terapeuta_form.last_name.errors }}</div>
            </div>


            <!-- Teléfono -->
            <div class="form-group">
                <label for="{{ terapeuta_form.telefono.id_for_label }}">{{ terapeuta_form.telefono.label }}</label>
                {{ terapeuta_form.telefono }}
                <div class="error">{{ terapeuta_form.telefono.errors }}</div>
            </div>

            <!-- Fecha de Nacimiento -->
            <div class="form-group">
                <label for="{{ terapeuta_form.fecha_nacimiento.id_for_label }}">{{ terapeuta_form.fecha_nacimiento.label }}</label>
                {{ terapeuta_form.fecha_nacimiento }}
                <div class="error">{{ terapeuta_form.fecha_nacimiento.errors }}</div>
            </div>

            <!-- Dirección -->
            <div class="form-group">
                <label for="{{ terapeuta_form.direccion.id_for_label }}">{{ terapeuta_form.direccion.label }}</label>
                {{ terapeuta_form.direccion }}
                <div class="error">{{ terapeuta_form.direccion.errors }}</div>
            </div>

            <!-- Región -->
            <div class="form-group">
                <label for="{{ terapeuta_form.region.id_for_label }}">{{ terapeuta_form.region.label }}</label>
                {{ terapeuta_form.region }}
                <div class="error">{{ terapeuta_form.region.errors }}</div>
            </div>

            <!-- Comuna -->
            <div class="form-group">
                <label for="{{ terapeuta_form.comuna.id_for_label }}">{{ terapeuta_form.comuna.label }}</label>
                {{ terapeuta_form.comuna }}
                <div class="error">{{ terapeuta_form.comuna.errors }}</div>
            </div>

            <!-- Presentación -->
            <div class="form-group">
                <label for="{{ terapeuta_form.presentacion.id_for_label }}">{{ terapeuta_form.presentacion.label }}</label>
                {{ terapeuta_form.presentacion }}
                <div class="error">{{ terapeuta_form.presentacion.errors }}</div>
            </div>
        </div>

        {% comment %} DATOS DEL terapeuta COLUMNA DERECHA {% endcomment %}
        
        <div class="datos-columna-derecha">

            <!-- Sexo -->
            <div class="form-group">
                <label for="{{ terapeuta_form.sexo.id_for_label }}">{{ terapeuta_form.sexo.label }}</label>
                {{ terapeuta_form.sexo }}
                <div class="error">{{ terapeuta_form.sexo.errors }}</div>
            </div>

            <!-- Campo Especialidad -->
            <div class="form-group">
                <label for="{{ terapeuta_form.especialidad.id_for_label }}">{{ terapeuta_form.especialidad.label }}</label>
                {{ terapeuta_form.especialidad }}
                <div class="error">{{ terapeuta_form.especialidad.errors }}</div>
            </div>

            <!-- Fecha de Contratación -->
            <div class="form-group">
                <label for="fecha_contratacion">Fecha de Contratación:</label>
                <div class="fecha_contratacion">
                    <input type="date" id="fecha_contratacion" name="fecha_contratacion" value="{{ terapeuta.fecha_contratacion|date:'Y-m-d' }}" readonly>
                </div>
            </div>

            <!-- Título -->
            <div class="form-group">
                <label for="{{ terapeuta_form.titulo.id_for_label }}">{{ terapeuta_form.titulo.label }}</label>
                {{ terapeuta_form.titulo }}
                <div class="error">{{ terapeuta_form.titulo.errors }}</div>
            </div>

            <!-- Años de Experiencia -->
            <div class="form-group">
                <label for="{{ terapeuta_form.experiencia.id_for_label }}">{{ terapeuta_form.experiencia.label }}</label>
                {{ terapeuta_form.experiencia }}
                <div class="error">{{ terapeuta_form.experiencia.errors }}</div>
            </div>

            <!-- Correo Electrónico de Contacto -->
            <div class="form-group">
                <label for="{{ terapeuta_form.correo_contacto.id_for_label }}">{{ terapeuta_form.correo_contacto.label }}</label>
                {{ terapeuta_form.correo_contacto }}
                <div class="error">{{ terapeuta_form.correo_contacto.errors }}</div>
            </div>

            <!-- Fecha de Ingreso -->
            <div class="form-group">
                <label for="{{ terapeuta_form.fecha_ingreso.id_for_label }}">{{ terapeuta_form.fecha_ingreso.label }}</label>
                {{ terapeuta_form.fecha_ingreso }}
                <div class="error">{{ terapeuta_form.fecha_ingreso.errors }}</div>
            </div>

            <!-- Campo Disponibilidad -->
            <div class="form-group">
                <label for="{{ terapeuta_form.disponibilidad.id_for_label }}">{{ terapeuta_form.disponibilidad.label }}</label>
                {{ terapeuta_form.disponibilidad }}
                <div class="error">{{ terapeuta_form.disponibilidad.errors }}</div>
            </div>
        </div>
    </div>

    <h2> Horarios del terapeuta </h2>
    {{ horario_formset.management_form }}
    <div class="datos-inferiores">
        <table class="table">
            <thead>
                <tr>
                    <th>Día</th>
                    <th>Hora de Inicio</th>
                    <th>Hora de Fin</th>
                    <th class="columna-eliminar">Eliminar</th>
                </tr>
            </thead>

            <label for="fulltime-checkbox">Horario Fulltime</label>
            <input class="fulltime-checkbox" type="checkbox" id="fulltime-checkbox" name="fulltime-checkbox">
            <label for="fulltime-checkbox">Horario Part Time (Fin de Semana)</label>
            <input class= "weekend-parttime-checkbox" type="checkbox" id="weekend-parttime-checkbox" name="weekend-parttime-checkbox">


            <tbody id="horarios-tbody">
                {% for form in horario_formset %}
                    <tr class="horario-row horario-row-existing" data-dia="{{ form.dia.value }}" data-hora-inicio="{{ form.hora_inicio.value }}" data-hora-fin="{{ form.hora_final.value }}">
                        <td>{{ form.dia }}</td>
                        <td>{{ form.hora_inicio }}</td>
                        <td>{{ form.hora_final }}</td>
                        <td>
                            <button type="button" class="delete-row-btn">Eliminar</button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>            
        </table>
        <button type="button" class="boton-azul" id="agregar-horario">Añadir Horario +</button>
    
        {% if horario_formset.non_field_errors %}
            <div class="error">
                {{ horario_formset.non_field_errors }}
            </div>
        {% endif %}
    </div>

    <div class="contenedor-botones">
        <button type="button" class="boton-cancelar" id="boton-cancelar">Cancelar</button>
        <button class="boton-azul" type="submit">Confirmar Cambios</button>
    </div>
</form>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        {% if messages %}
            {% for message in messages %}
                Swal.fire({
                    title: '¡Éxito al Guardar!',
                    icon: 'success',
                    confirmButtonText: 'Aceptar',
                    confirmButtonColor: '#3085d6',
                    background: '#f0f0f0',
                    timer: 2000,
                });
            {% endfor %}
        {% endif %}
    });


    document.getElementById("boton-cancelar").addEventListener("click", function(){
        window.location.href = "{% url 'mostrar_terapeuta_administrador' terapeuta.id %}";
    });

    document.addEventListener("DOMContentLoaded", function() {
        var regionField = document.getElementById("id_region");
        var comunaField = document.getElementById("id_comuna");

        regionField.addEventListener("change", function() {
            var regionId = this.value;
            comunaField.innerHTML = ""; // Limpiar opciones anteriores

            if (regionId) {
                fetch(`/api/comunas/?region=${regionId}`)
                .then(response => response.json())
                .then(data => {
                    // Actualizar opciones del campo de selección de comuna
                    data.forEach(comuna => {
                        var option = document.createElement("option");
                        option.value = comuna.id;
                        option.textContent = comuna.nombre;
                        comunaField.appendChild(option);
                    });
                });
            }
        });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const addScheduleButton = document.getElementById('agregar-horario');
        const horariosTbody = document.getElementById('horarios-tbody');
        const totalFormsInput = document.querySelector('input[name="horario_set-TOTAL_FORMS"]');
        let scheduleIndex = parseInt(totalFormsInput.value) || 0;
    
        const fullTimeCheckbox = document.getElementById('fulltime-checkbox');
        const weekendPartTimeCheckbox = document.getElementById('weekend-parttime-checkbox');
    
        fullTimeCheckbox.addEventListener('change', function () {
            if (fullTimeCheckbox.checked) {
                clearScheduleRows();
                const days = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];
                days.forEach(day => {
                    addScheduleRow(day, '08:00', '18:00');
                });
            } else {
                resetScheduleToExistingData(); // Cargar los datos actuales en lugar de limpiar
            }
        });
    
        weekendPartTimeCheckbox.addEventListener('change', function () {
            if (weekendPartTimeCheckbox.checked) {
                clearScheduleRows();
                const days = ['Sábado', 'Domingo'];
                days.forEach(day => {
                    addScheduleRow(day, '08:00', '18:00');
                });
            } else {
                resetScheduleToExistingData();
            }
        });
    
        addScheduleButton.addEventListener('click', function () {
            addScheduleRow();
        });
    
        function addScheduleRow(day = '---------', horaInicio = '', horaFin = '') {
            const newRow = document.createElement('tr');
            newRow.className = 'horario-row';
    
            const diaSelect = document.createElement('select');
            diaSelect.name = `horario_set-${scheduleIndex}-dia`;
            diaSelect.className = 'seleccion';
            diaSelect.id = `id_horario_set-${scheduleIndex}-dia`;
    
            const days = ['---------', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
            days.forEach(d => {
                const option = document.createElement('option');
                option.value = d;
                option.textContent = d;
                if (d === day) {
                    option.selected = true;
                }
                diaSelect.appendChild(option);
            });
    
            const horaInicioInput = document.createElement('input');
            horaInicioInput.type = 'time';
            horaInicioInput.name = `horario_set-${scheduleIndex}-hora_inicio`;
            horaInicioInput.className = 'campo-formulario';
            horaInicioInput.id = `id_horario_set-${scheduleIndex}-hora_inicio`;
            horaInicioInput.value = horaInicio;
    
            const horaFinInput = document.createElement('input');
            horaFinInput.type = 'time';
            horaFinInput.name = `horario_set-${scheduleIndex}-hora_final`;
            horaFinInput.className = 'campo-formulario';
            horaFinInput.id = `id_horario_set-${scheduleIndex}-hora_final`;
            horaFinInput.value = horaFin;
    
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Eliminar';
            deleteButton.type = 'button';
            deleteButton.className = 'delete-row-btn';
            deleteButton.addEventListener('click', function () {
                horariosTbody.removeChild(newRow);
                updateTotalForms();
                toggleDeleteButtons();
            });
    
            newRow.appendChild(tdElement(diaSelect));
            newRow.appendChild(tdElement(horaInicioInput));
            newRow.appendChild(tdElement(horaFinInput));
            newRow.appendChild(tdElement(deleteButton));
    
            horariosTbody.appendChild(newRow);
    
            totalFormsInput.value = scheduleIndex + 1;
            scheduleIndex++;
            toggleDeleteButtons();
        }
    
        function clearScheduleRows() {
            while (horariosTbody.firstChild) {
                horariosTbody.removeChild(horariosTbody.firstChild);
            }
            scheduleIndex = 0;
            totalFormsInput.value = scheduleIndex;
        }
    
        function resetScheduleToExistingData() {
            const existingRows = document.querySelectorAll('.horario-row-existing');
            existingRows.forEach(row => {
                const deleteButton = row.querySelector('.delete-row-btn');
                deleteButton.addEventListener('click', function () {
                    horariosTbody.removeChild(row);
                    updateTotalForms();
                    toggleDeleteButtons();
                });
            });
        }
    
        function tdElement(...children) {
            const td = document.createElement('td');
            children.forEach(child => td.appendChild(child));
            return td;
        }
    
        function updateTotalForms() {
            totalFormsInput.value = horariosTbody.childElementCount;
            scheduleIndex = parseInt(totalFormsInput.value);
        }
    
        function toggleDeleteButtons() {
            const deleteButtons = document.querySelectorAll('.delete-row-btn');
            deleteButtons.forEach(button => {
                button.disabled = horariosTbody.childElementCount <= 1;
            });
        }
    
        toggleDeleteButtons();
        resetScheduleToExistingData();  // Llama a esta función para inicializar el evento de eliminación en filas originales
    });
    
    
</script>

<script src="{% static 'js/formatear-rut.js' %}"></script>
<script src="{% static 'js/formatear-telefono.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}